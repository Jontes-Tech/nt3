<script lang="ts">
  import Special from "./Special.svelte";

  interface Result {
    title: string;
    link: URL;
    description: string;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const query = urlParams.get("query");
  const token = urlParams.get("token") + "";
  let results: Result[] = [];
  let loaded = false;
  let special: Result | null = null;
  if (!query) {
    window.location.href = "/";
  } else {
    const search = async () => {
      const res = await fetch(
        `http://localhost:3000/?country=se-sv&query=${encodeURIComponent(
          query
        )}&token=${encodeURIComponent(token)}`
      );
      if (res.status === 403) {
        window.location.href = "/intermediate?query=" + query;
      }
      const between = await res.json();
      between.forEach((result: Result) => {
        result.link = new URL(result.link);
      });
      const json: Result[] = between;
      // Find the first special domain, if any
      for (let i = 0; i < Math.min(6, json.length); i++) {
        if (specialDomains.includes(new URL(json[i].link).hostname) || json[i].link.hostname.slice(-14) === ".wikipedia.org") {
          console.log("Found special domain", json[i]);
          json[i].link = new URL(json[i].link);
          special = json[i];
          json.splice(i, 1);
          break;
        }
      }
      results = json;
      loaded = true;
    };
    search();
  }
  const specialDomains = ["www.youtube.com", "jontes.page"];
</script>

{#if loaded}
  <svg
    class="mx-auto"
    width="552.236"
    height="75.339"
    viewBox="0 0 552.236 75.339"
    xmlns="http://www.w3.org/2000/svg"
    ><g
      id="svgGroup"
      stroke-linecap="round"
      fill-rule="evenodd"
      font-size="9pt"
      stroke="#000"
      stroke-width="0.25mm"
      fill="#000"
      style="stroke:#000;stroke-width:0.25mm;fill:#000"
      ><path
        d="M 156.503 64.869 L 158.086 64.869 C 161.493 62.084 165.881 60.525 170.281 60.525 A 19.247 19.247 0 0 1 184.253 66.555 L 195.44 57.394 L 209.75 67.13 L 232.235 50.287 L 232.235 11.606 L 224.077 3.927 L 212.652 12.477 C 212.652 9.993 212.652 7.51 212.652 5.026 L 210.263 5.026 C 210.263 21.311 210.263 37.596 210.263 53.88 L 205.902 50.948 L 205.902 11.594 L 197.743 3.865 L 186.402 12.352 C 186.402 9.91 186.402 7.468 186.402 5.026 L 184.013 5.026 C 184.013 20.863 184.013 36.7 184.013 52.537 A 22.923 22.923 0 0 0 180.211 51.648 L 180.211 23.453 L 180.211 22.036 C 180.211 20.791 180.233 19.545 180.233 18.299 C 180.233 15.552 180.181 13.323 179.312 11.036 A 10.343 10.343 0 0 0 173.122 4.974 A 13.106 13.106 0 0 0 168.552 4.193 A 12.319 12.319 0 0 0 162.69 5.614 C 159.42 7.379 157.401 10.619 157.728 14.37 L 159.812 14.37 C 160.225 12.308 162.052 10.447 164.461 10.447 A 4.81 4.81 0 0 1 165.604 10.576 C 168.776 11.35 168.654 15.356 168.645 15.839 A 2.028 2.028 0 0 0 168.645 15.87 L 168.627 22.87 A 126611.249 126611.249 0 0 0 168.627 24.726 A 126611.249 126611.249 0 0 1 168.627 26.581 C 166.525 26.874 164.452 27.148 162.57 28.032 A 8.303 8.303 0 0 0 158.309 32.48 C 157.928 33.434 157.702 34.512 157.676 35.713 A 10.865 10.865 0 0 0 157.673 35.954 A 9.834 9.834 0 0 0 157.673 36.029 A 10.139 10.139 0 0 0 158.947 40.856 L 160.54 40.856 A 5.586 5.586 0 0 1 160.465 40.269 C 160.317 38.264 161.405 36.931 163.144 36.357 A 6.944 6.944 0 0 1 165.314 36.036 C 166.418 36.036 167.522 36.036 168.627 36.036 A 560969.052 560969.052 0 0 0 168.627 44.536 A 560969.029 560969.029 0 0 1 168.627 53.036 A 22.079 22.079 0 0 0 163.36 56.142 C 160.047 58.763 157.801 62.008 156.619 64.607 A 17.02 17.02 0 0 0 156.503 64.869 Z M 38.169 18.893 L 38.169 29.18 L 32.692 34.657 L 38.169 40.133 L 38.169 54.323 A 20.344 20.344 0 0 1 31.579 56.333 A 21.107 21.107 0 0 1 28.919 56.5 A 19.238 19.238 0 0 1 21.83 55.186 A 18.157 18.157 0 0 1 15.668 51.15 L 30.354 44.969 L 30.36 19.67 L 12.014 27.489 A 23.166 23.166 0 0 1 13.41 24.933 C 15.979 20.855 19.229 18.44 20.426 17.631 L 19.627 16.432 A 22.87 22.87 0 0 0 7.992 21.979 C 3.479 26.018 0.737 31.649 0.129 37.281 A 22.12 22.12 0 0 0 0.001 39.653 A 25.142 25.142 0 0 0 5.614 55.656 A 27.302 27.302 0 0 0 26.646 65.645 C 40.164 65.645 50.8 55.53 50.8 42.806 A 21.629 21.629 0 0 0 50.799 42.736 A 21.551 21.551 0 0 0 50.784 41.998 L 49.187 41.998 A 23.969 23.969 0 0 1 43.181 50.833 A 22.275 22.275 0 0 1 40.502 52.958 L 40.502 40.221 L 46.066 34.657 L 40.502 29.092 L 40.502 19.06 A 8.364 8.364 0 0 1 40.54 19.06 A 8.334 8.334 0 0 0 40.577 19.061 C 46.597 19.061 51.886 15.859 51.886 9.849 C 51.886 4.121 46.528 0 39.432 0 A 18.85 18.85 0 0 0 38.002 0.055 L 38.002 1.653 A 156.257 156.257 0 0 1 38.994 1.787 C 41.372 2.123 44.202 2.715 44.35 5.116 A 3.243 3.243 0 0 1 44.357 5.315 A 2.361 2.361 0 0 1 43.955 6.677 C 43.574 7.233 42.955 7.608 42.238 7.812 A 5.116 5.116 0 0 1 40.848 7.997 A 22.277 22.277 0 0 1 36.436 7.484 C 29.995 6.163 22.38 2.709 16.711 2.126 A 15.112 15.112 0 0 0 15.168 2.042 A 16.018 16.018 0 0 0 9.388 3.06 C 6.987 3.986 5.093 5.486 3.819 7.321 A 10.321 10.321 0 0 0 1.962 13.236 A 9.816 9.816 0 0 0 2.72 17.09 C 3.636 19.254 5.295 20.862 7.206 21.819 A 9.844 9.844 0 0 0 7.643 22.025 L 8.442 20.827 A 3.521 3.521 0 0 1 6.709 19.07 C 6.525 18.653 6.416 18.179 6.408 17.652 A 4.143 4.143 0 0 1 6.408 17.587 C 6.408 15.435 7.863 14.08 9.803 13.531 A 7.786 7.786 0 0 1 11.914 13.251 A 11.626 11.626 0 0 1 13.619 13.418 C 19.006 14.263 31.152 18.048 38.169 18.893 Z M 378.002 18.893 L 378.002 29.18 L 372.525 34.657 L 378.002 40.133 L 378.002 54.323 A 20.344 20.344 0 0 1 371.412 56.333 A 21.107 21.107 0 0 1 368.752 56.5 A 19.238 19.238 0 0 1 361.663 55.186 A 18.157 18.157 0 0 1 355.501 51.15 L 370.188 44.969 L 370.193 19.67 L 351.848 27.489 A 23.166 23.166 0 0 1 353.244 24.933 C 355.813 20.855 359.062 18.44 360.259 17.631 L 359.46 16.432 A 22.87 22.87 0 0 0 347.825 21.979 C 343.312 26.018 340.57 31.649 339.963 37.281 A 22.12 22.12 0 0 0 339.834 39.653 A 25.142 25.142 0 0 0 345.447 55.656 A 27.302 27.302 0 0 0 366.48 65.645 C 379.998 65.645 390.633 55.53 390.633 42.806 A 21.629 21.629 0 0 0 390.633 42.736 A 21.551 21.551 0 0 0 390.618 41.998 L 389.02 41.998 A 23.969 23.969 0 0 1 383.014 50.833 A 22.275 22.275 0 0 1 380.335 52.958 L 380.335 40.221 L 385.9 34.657 L 380.335 29.092 L 380.335 19.06 A 8.364 8.364 0 0 1 380.373 19.06 A 8.334 8.334 0 0 0 380.411 19.061 C 386.43 19.061 391.719 15.859 391.719 9.849 C 391.719 4.121 386.361 0 379.265 0 A 18.85 18.85 0 0 0 377.835 0.055 L 377.835 1.653 A 156.257 156.257 0 0 1 378.827 1.787 C 381.205 2.123 384.036 2.715 384.184 5.116 A 3.243 3.243 0 0 1 384.19 5.315 A 2.361 2.361 0 0 1 383.788 6.677 C 383.408 7.233 382.789 7.608 382.071 7.812 A 5.116 5.116 0 0 1 380.681 7.997 A 22.277 22.277 0 0 1 376.269 7.484 C 369.828 6.163 362.213 2.709 356.544 2.126 A 15.112 15.112 0 0 0 355.002 2.042 A 16.018 16.018 0 0 0 349.221 3.06 C 346.82 3.986 344.926 5.486 343.652 7.321 A 10.321 10.321 0 0 0 341.795 13.236 A 9.816 9.816 0 0 0 342.553 17.09 C 343.469 19.254 345.129 20.862 347.039 21.819 A 9.844 9.844 0 0 0 347.477 22.025 L 348.275 20.827 A 3.521 3.521 0 0 1 346.542 19.07 C 346.359 18.653 346.25 18.179 346.242 17.652 A 4.143 4.143 0 0 1 346.241 17.587 C 346.241 15.435 347.696 14.08 349.636 13.531 A 7.786 7.786 0 0 1 351.747 13.251 A 11.626 11.626 0 0 1 353.453 13.418 C 358.839 14.263 370.985 18.048 378.002 18.893 Z M 459.879 59.781 L 455.552 55.92 L 455.552 33.632 L 459.934 30.976 L 465.715 36.239 L 465.715 56.778 L 462.216 59.976 L 470.474 67.163 L 482.835 59.142 L 482.78 56.087 L 479.196 58.781 L 475.302 54.809 L 475.302 33.871 L 479.42 30.531 L 477.951 28.719 L 475.237 30.92 L 466.582 23.456 L 455.125 30.608 L 446.832 23.456 L 435.882 30.292 L 429.754 23.456 L 418.169 31.445 L 419.368 33.043 L 422.563 31.046 L 425.759 34.641 L 425.759 56.778 L 422.563 59.574 L 432.15 67.163 L 440.139 59.973 L 436.544 56.778 L 436.544 33.182 L 440.184 30.976 L 445.965 36.239 L 445.965 56.778 L 442.466 59.976 L 450.724 67.163 L 459.879 59.781 Z M 71.195 55.979 L 71.195 35.443 L 75.828 31.104 L 80.782 35.207 L 80.782 56.448 C 80.782 61.896 79.567 67.146 77.111 70.262 A 6.885 6.885 0 0 1 71.594 73.156 L 71.594 75.152 A 18.034 18.034 0 0 0 74.178 75.338 A 23.586 23.586 0 0 0 79.966 74.678 C 89.477 72.273 91.568 63.739 91.567 56.448 L 91.565 32.648 L 95.151 29.74 L 93.681 27.927 L 90.394 30.593 L 81.581 23.223 L 71.195 32.95 L 71.195 2.052 L 69.597 2.052 L 56.015 11.639 L 56.016 12.837 C 60.008 14.053 60.01 15.875 60.01 17.231 L 60.01 55.18 L 54.418 58.775 L 55.837 60.695 L 59.033 58.698 L 67.6 65.965 L 77.985 58.775 L 76.491 56.896 L 73.904 58.695 L 71.195 55.979 Z M 307.347 56.14 L 288.544 66.805 L 275.964 59.209 L 272.768 61.206 L 271.57 59.608 L 277.162 56.013 L 277.162 17.231 A 3.684 3.684 0 0 0 276.186 14.395 C 275.586 13.795 274.64 13.282 273.168 12.837 L 273.168 11.639 L 286.749 2.052 L 288.347 2.052 L 288.347 30.347 L 298.847 23.49 L 307.347 31.448 L 307.347 56.14 Z M 98.039 60.572 L 101.728 57.581 L 114.092 66.764 L 131.268 52.783 L 130.07 50.786 L 120.882 57.976 L 110.896 51.185 L 110.896 47.59 L 128.871 36.405 L 128.871 36.006 L 120.483 23.223 L 100.51 33.609 L 100.51 55.564 L 96.569 58.76 L 98.039 60.572 Z M 237.872 60.572 L 241.561 57.581 L 253.925 66.764 L 271.102 52.783 L 269.903 50.786 L 260.716 57.976 L 250.729 51.185 L 250.729 47.59 L 268.705 36.405 L 268.705 36.006 L 260.316 23.223 L 240.343 33.609 L 240.343 55.564 L 236.403 58.76 L 237.872 60.572 Z M 484.872 60.572 L 488.561 57.581 L 500.925 66.764 L 518.102 52.783 L 516.903 50.786 L 507.716 57.976 L 497.729 51.185 L 497.729 47.59 L 515.705 36.405 L 515.705 36.006 L 507.316 23.223 L 487.343 33.609 L 487.343 55.564 L 483.403 58.76 L 484.872 60.572 Z M 525.968 70.292 L 526.781 68.105 C 526.114 67.727 525.594 67.026 525.594 66.035 A 2.941 2.941 0 0 1 527.379 63.366 C 527.998 63.06 528.72 62.896 529.441 62.884 A 5.109 5.109 0 0 1 529.523 62.884 A 6.421 6.421 0 0 1 532.424 63.564 C 533.884 64.294 534.983 65.52 535.694 66.781 L 552.147 56.781 L 552.147 44.198 L 544.969 38.883 A 22.298 22.298 0 0 0 549.161 33.774 C 550.651 31.238 551.526 28.461 552.008 25.267 A 38.443 38.443 0 0 0 552.236 23.448 L 549.882 23.448 A 0.024 0.024 0 0 1 549.881 23.452 A 0.024 0.024 0 0 0 549.881 23.456 L 549.85 23.448 A 3.939 3.939 0 0 1 546.765 26.795 A 4.621 4.621 0 0 1 545.68 26.922 A 6.306 6.306 0 0 1 542.683 26.161 C 541.444 25.5 540.458 24.494 539.741 23.488 A 10.456 10.456 0 0 1 539.597 23.281 L 522.375 33.281 L 522.375 44.948 L 528.688 49.928 C 522.918 55.287 521.175 58.294 520.843 61.301 A 11.049 11.049 0 0 0 520.779 62.516 C 520.779 66.428 523.093 69.18 525.968 70.292 Z M 416.964 56.378 L 413.369 58.775 L 410.573 55.979 L 410.573 30.813 L 404.182 23.223 L 392.997 30.813 L 394.195 32.411 L 397.391 30.413 L 400.187 34.009 L 400.187 55.979 L 394.994 59.574 L 396.192 61.172 L 398.989 59.174 L 406.978 66.365 L 418.961 57.976 L 416.964 56.378 Z M 288.347 33.083 L 288.347 54.781 L 297.097 59.906 L 297.097 35.865 L 292.097 30.643 L 288.347 33.083 Z M 10.913 30.346 L 19.604 26.679 L 19.605 47.057 L 14.115 49.397 A 20.072 20.072 0 0 1 9.962 38.111 A 21.193 21.193 0 0 1 9.931 36.976 A 22.933 22.933 0 0 1 10.227 33.281 A 22.018 22.018 0 0 1 10.913 30.346 Z M 350.747 30.346 L 359.438 26.679 L 359.438 47.057 L 353.949 49.397 A 20.072 20.072 0 0 1 349.795 38.111 A 21.193 21.193 0 0 1 349.765 36.976 A 22.933 22.933 0 0 1 350.06 33.281 A 22.018 22.018 0 0 1 350.747 30.346 Z M 212.652 40.466 L 221.485 36.007 L 221.485 54.587 L 216.584 58.13 L 211.775 54.897 L 212.652 54.895 C 212.652 50.086 212.652 45.276 212.652 40.466 Z M 536.779 45.942 L 541.397 49.62 L 541.397 60.476 C 539.909 57.202 536.655 54.266 532.124 54.079 A 11.149 11.149 0 0 0 531.665 54.07 A 9.538 9.538 0 0 0 527.604 54.963 A 9.065 9.065 0 0 0 525.825 56.063 A 28.833 28.833 0 0 1 528.021 53.657 C 529.749 51.945 531.769 50.246 533.785 48.514 L 536.779 45.942 Z M 186.402 40.466 L 195.152 36.049 L 195.152 50.811 L 189.753 55.365 A 21.941 21.941 0 0 0 186.402 53.467 C 186.402 49.133 186.402 44.8 186.402 40.466 Z M 536.571 43.046 L 533.125 39.526 L 533.124 28.67 C 534.806 32.847 538.363 34.743 541.92 34.801 A 10.335 10.335 0 0 0 542.087 34.802 A 10.562 10.562 0 0 0 545.603 34.21 A 9.942 9.942 0 0 0 546.271 33.947 A 18.35 18.35 0 0 1 544.845 35.72 C 544.458 36.145 544.066 36.539 543.674 36.908 A 28.329 28.329 0 0 1 542.708 37.775 L 536.571 43.046 Z M 186.402 14.684 L 189.766 12.162 L 195.152 16.636 L 195.152 24.626 L 186.402 29.044 C 186.402 24.257 186.402 19.47 186.402 14.684 Z M 212.652 14.809 L 216.099 12.224 L 221.485 16.698 L 221.485 24.584 L 212.652 29.044 C 212.652 24.299 212.652 19.554 212.652 14.809 Z M 397.518 11.98 L 404.621 20.07 L 412.581 13.081 L 405.478 4.992 L 397.518 11.98 Z M 110.896 44.721 L 110.896 30.514 L 112.494 29.615 L 119.267 39.417 L 110.896 44.721 Z M 250.729 44.721 L 250.729 30.514 L 252.327 29.615 L 259.101 39.417 L 250.729 44.721 Z M 497.729 44.721 L 497.729 30.514 L 499.327 29.615 L 506.101 39.417 L 497.729 44.721 Z M 212.652 31.719 L 221.485 27.26 L 221.485 33.331 L 212.652 37.79 C 212.652 35.767 212.652 33.743 212.652 31.719 Z M 186.402 31.719 L 195.152 27.302 L 195.152 33.373 L 186.402 37.79 C 186.402 35.767 186.402 33.743 186.402 31.719 Z"
        vector-effect="non-scaling-stroke"
      /></g
    ></svg
  >
  <Special {special} />
  {#if special}
    <p class="text-2xl mt-12">Other results</p>
  {/if}
  <ol class="mt-2">
    {#each results as result}
      <a href={result.link.href}>
        <li class="p-2 rounded bg-neutral-100 my-2">
          <span class="text-sm text-neutral-600"
            ><img
              src={"https://external-content.duckduckgo.com/ip3/" +
                result.link.hostname +
                ".ico"}
              alt=""
              class="h-8 w-8 bg-neutral-600 p-1 rounded inline mr-2"
            />{result.link.hostname}</span
          >
          <h2 class="text-lg">{result.title}</h2>
          <p class="text-sm text-neutral-600">{result.description}</p>
        </li>
      </a>
    {/each}
  </ol>
{:else}
  <div class="flex justify-center items-center h-screen">
    <div
      class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"
    />
  </div>
{/if}
